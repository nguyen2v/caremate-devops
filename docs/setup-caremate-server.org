#+title: Setup Caremate Server
#+date: <2025-07-27 Sun 11:38>
#+startup: content
#+property: header-args :noweb yes :dir (projectile-project-root) :results none
#+filetags: :Setup:Caremate:Server:

* Prerequisites
- Ensure Ansible is installed and configured
- Verify SSH access to the server
- Confirm DNS propagation before SSL setup

* Add caremate-server IP to /etc/hosts
#+begin_src
# glcoud servers
34.126.130.128 caremate-server
34.142.157.137 jitsi-server

# linode cloud
172.236.130.227 linode-caremate-server
#+end_src

* SSH into caremate server using host name
** Google
#+begin_src bash
ssh dhp@caremate-server
#+end_src

** Linode
#+begin_src bash
ssh root@linode-caremate-server
#+end_src

* Setup TARGET_SERVER
#+name: TARGET_SERVER
#+begin_src bash
linode-caremate-server
#+end_src

* Setup core packages
#+begin_src bash
ansible-playbook playbooks/setup-core-config.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Setup docker
#+begin_src bash
ansible-playbook playbooks/setup-docker.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Setup Nodejs
#+begin_src bash
ansible-playbook playbooks/setup-nodejs.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Setup SSH key
#+begin_src bash
ansible-playbook playbooks/setup-ssh-key.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Setup caremate source code
#+begin_src bash
ansible-playbook playbooks/setup-caremate-project.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Start postgres and redis
#+begin_src bash
ssh root@linode-caremate-server

cd caremate

docker compose up -d postgres
docker compose up -d redis
#+end_src

* Restore data
#+begin_src bash
ansible-playbook playbooks/restore-caremate-server.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Issue HTTPS Certificate
** Configure DNS
- Add caremate-server IP to =https://domain.tenten.vn/ApiDnsSetting= DNS config
 | Type     | Host |           Value | TTL       |
 |----------+------+-----------------+-----------|
 | A Record | api  | 172.236.130.227 | Automatic |

- Wait for DNS propagation
#+begin_src bash
dig +short api.fpt-healthcare.com
#+end_src

** Issue new certificate
#+begin_src bash
ansible-playbook playbooks/setup-nginx.yaml \
  --extra-vars='{ "ssl": false }' \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Docker compose port mappings

| Servic          |                                 Port |
|-----------------+--------------------------------------|
| postgres        |                            5432:5432 |
| redis           |                            6379:6379 |
| caremate-server |                            8103:8103 |
| nginx           | 80:80, 443:443, 7474:7474, 7687:7687 |
| chroma-server   |                            8001:8000 |
| neo4j           |               17474:7474, 17687:7687 |
| ai-scribe       |                            8000:8000 |
| care-assistant  |                            3002:3002 |
| cengine-api     |                            8003:8000 |
| mental-care     |                            8004:8000 |
| doc-cat-api     |                            8005:8000 |

* Deploy caremate-server
** Update env
#+begin_src bash
ansible-playbook playbooks/update-caremate-project-env.yaml \
  --limit=linode-caremate-server \
  --verbose
#+end_src

** Deploy server
#+begin_src bash
ansible-playbook playbooks/deploy-caremate-server.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

** Deploy manually
#+begin_src bash
export SERVER_DOCKERHUB_REPOSITORY=caremate-server
export GITHUB_SHA=aa5f59f

./scripts/build-docker-server.sh
#+end_src

* Deploy ai-scribe
#+begin_src bash
ansible-playbook playbooks/deploy-caremate-service.yaml \
  --limit=<<TARGET_SERVER>> \
  --extra-vars='{ "service_name": "caremate-assistant", "sub_project": "ai-scribe" }' \
  --verbose
#+end_src

* Deploy caremate-mcp
#+begin_src bash
ansible-playbook playbooks/deploy-caremate-service.yaml \
  --limit=<<TARGET_SERVER>> \
  --extra-vars='{ "service_name": "caremate-mcp" }' \
  --verbose
#+end_src

* Deploy caremate-agent
#+begin_src bash
ansible-playbook playbooks/deploy-caremate-service.yaml \
  --limit=<<TARGET_SERVER>> \
  --extra-vars='{ "service_name": "caremate-agent" }' \
  --verbose
#+end_src

* Deploy care-assistant
#+begin_src bash
ansible-playbook playbooks/deploy-caremate-service.yaml \
  --limit=<<TARGET_SERVER>> \
  --extra-vars='{ "service_name": "caremate-assistant", "sub_project": "care-assistant" }' \
  --verbose
#+end_src

* Deploy cengine-api
#+begin_src bash
ansible-playbook playbooks/deploy-caremate-service.yaml \
  --limit=<<TARGET_SERVER>> \
  --extra-vars='{ "service_name": "cengine-api" }' \
  --verbose
#+end_src

** Seed data
#+begin_src bash
ansible-playbook playbooks/seed-cengine-api.yaml
#+end_src

* Deploy doc-cat-api
#+begin_src bash
ansible-playbook playbooks/deploy-caremate-service.yaml \
  --limit=<<TARGET_SERVER>> \
  --extra-vars='{ "service_name": "doc-cat-api" }' \
  --verbose
#+end_src

* Deploy mental-care
#+begin_src bash
ansible-playbook playbooks/deploy-caremate-service.yaml \
  --limit=<<TARGET_SERVER>> \
  --extra-vars='{ "service_name": "mental-care" }' \
  --verbose
#+end_src

* Deploy nginx
#+begin_src bash
ansible-playbook playbooks/setup-nginx.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Setup Github Workflows
#+begin_src bash
ansible-playbook playbooks/setup-github-workflows.yaml \
  --extra-vars='{ "project_name": "caremate-portal" }' \
  --verbose
#+end_src

* Backup data
#+begin_src bash
ansible-playbook playbooks/backup-caremate-server.yaml \
  --verbose
#+end_src
