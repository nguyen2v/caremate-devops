#+title: Setup Healthchain Server
#+date: <2025-12-15 Mon 21:28>
#+startup: content
#+property: header-args :noweb yes :results none
#+filetags: :Setup:HealthChain:

* Set variables
#+name: TARGET_SERVER
#+begin_src bash
linode-chain-server
#+end_src

* Add chain-server and pacs-server to /etc/hosts
#+begin_src
# linode cloud
172.236.136.69  linode-chain-server
172.237.87.80   linode-pacs-server
#+end_src

* Verify SSH connection
#+begin_src bash :comint
ssh root@linode-caremate-server
#+end_src

#+begin_src bash :comint
ssh root@linode-pacs-server
#+end_src

* Setup core packages
#+begin_src bash
ansible-playbook playbooks/setup-core-config.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Setup SSH key
#+begin_src bash
ansible-playbook playbooks/setup-ssh-key.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Setup docker
#+begin_src bash
ansible-playbook playbooks/setup-docker.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Setup caremate-chain source code
#+begin_src bash
ansible-playbook playbooks/setup-caremate-project.yaml \
  --limit=linode-chain-server \
  --verbose
#+end_src

* Setup pacs source code
#+begin_src bash
ansible-playbook playbooks/setup-pacs-project.yaml \
  --limit=linode-pacs-server \
  --verbose
#+end_src

* Issue HTTP Certificate
** Configure DNS
- Add =pacs= entry to DNS config
 | Type | Host  |          Value | TTL  |
 |------+-------+----------------+------|
 | A    | chain | 172.236.136.69 | Auto |
 | A    | pacs  |  172.237.87.80 | Auto |

- Wait for DNS propagation
#+begin_src bash
dig +short chain.fpt-healthcare.com
dig +short pacs.fpt-healthcare.com
#+end_src

** Issue new Certificate
#+begin_src bash
ansible-playbook playbooks/setup-nginx.yaml \
  --extra-vars='{ "ssl": false }' \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src

* Deploy caremate-chain
#+begin_src bash
ansible-playbook playbooks/deploy-caremate-chain.yaml \
  --limit=linode-chain-server \
  --extra-vars='{ "service_name": "sepsis" }' \
  --verbose
#+end_src

* Deploy nginx (HTTPS)
#+begin_src bash
ansible-playbook playbooks/setup-nginx.yaml \
  --limit=<<TARGET_SERVER>> \
  --verbose
#+end_src
